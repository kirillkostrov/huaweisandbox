<template>
  <!-- Only one root node is allowed in template. -->
  <div class="container">
    <div class="top-button-container">
      <!-- <input class="button" type="button" value="ПОДЕЛИТЬСЯ" onclick="openShare()"/> -->
      <image class="share-image" src="../Common/ic_jokes_share_round.png" onclick="openShare()"/>
    </div>
    <div class="text-container">
      <div class="text-block">
        <text class="{{fontClass}}">
          {{text}}
        </text>
      </div>    
    </div>
    <div class="button-container">
      <input class="button bottom-button" type="button" value="АНЕКДОТ" onclick="loadNew(1)"/>
      <input class="button bottom-button button2" type="button" value="ИСТОРИЯ" onclick="loadNew(2)"/>
    </div>
  </div>
</template>

<style>
  .container {
    flex-direction: column;
    justify-content: flex-end;
    padding: 20px;
  }

  .share-image {
    width: 100px;
    height: 100px;
  }

  .top-button-container {
    flex-direction: row;
    justify-content:flex-end;
    align-items: flex-end;
    width: 100%;
    height: 120px;
  }

  .button-container {
    flex-direction: row;
    justify-content:flex-end;
    align-items: center;
    padding: 10px;
  }

  .text-container {
    flex-direction: column;
    justify-content: center;
    height: 100%;
    width: 100%;
    padding: 40px;
  }

  .text-block {
    width:100%;
  }

  .big-font {
    font-size: 50px;
  }

  .medium-font {
    font-size: 40px;
  }

  .small-font {
    font-size: 30px;
  }

  .button {
    color: #ffffff;
    background-color:#666666;
    border-radius: 15px;
    font-size: 40px;
    height: 90px;
    margin: 15px;    
  }

  .bottom-button {
    width: 45%;
  }

  .button2 {
    margin-left: 20px;
  }
</style>

<script>
  import fetch from '@system.fetch'
  import share from '@system.share'

  module.exports = {
    data: {
      componentData: {},
      text: '- Как только утром по телевидению начинается аэробика, мой муж\nтут же вскакивает с кровати.\n- Он так увлечен аэробикой в его-то годы?\n- Нет, сам он ею не занимается, а наблюдает в окно, как выполняет эти упражнения полуобнаженная молоденькая соседка.',
      fontClass: 'big-font'      
    },
    onInit() {
      this.$page.setTitleBar({
        text: 'menu',
        textColor: '#ffffff',
        backgroundColor: '#666666',
        backgroundOpacity: 1,
        menu: true
      });

      this.loadNew(1);
    },
    loadNew(jokeCat) {
      let context = this;
      fetch.fetch(
        {
          url:"http://rzhunemogu.ru/RandJSON.aspx?CType="+jokeCat,
          success: function(data)  {
            try {
              //console.log(data.data.replace(/(?:\r\n|\r|\n)/g, '<br>'));
              //let result = JSON.parse(data.data.replace(/(?:\r\n|\r|\n)/g, '<br>'));             
              //let finalText = result.content.split('<br>').join('\n'); 

              // This weird way of getting content used because API returns not well-formed json sometimes
              // It just adds prefix {content:" and suffix "} to the text
              // ignoring inner carriage returns, quotes and backslash, causing JSON.parse to fail with exception

              let finalText = data.data.replace("{\"content\":\"", "").replace("\"}", "");

              if (finalText.length < 256) {
                context.fontClass = 'big-font';
              } else if (finalText.length > 600) {
                context.fontClass = 'small-font';
              } else {
                context.fontClass = 'medium-font';
              }
              console.log(context.fontClass);
              context.text = finalText;              
              } catch (error) {
                console.log(error);
                context.fontClass = 'big-font';
                context.text = 'Ошибка загрузки, попробуйте ещё раз'; 
              }
          },
          fail: function(data, code) {
            console.log("handling fail, code=" + code);
          }
        })            
    },
    openShare() {
      let sharetext = this.text;
      sharetext += "\n\nАнекдоты, байки, реальные смешные истории из жизни.\n";
      sharetext += "https://appgallery.huawei.com/#/app/C103270485";      
      share.share({
        type: "text/html",
        data: sharetext,
        success: function(data){
          console.log("handling success");
          },
        fail: function(data, code) {
        console.log("handling fail, code=" + code);
        },
      });
    }

  }
</script>